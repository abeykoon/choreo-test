## 18.4 Kubernetes Resource Migrator Service

The **Kubernetes Resource Migrator** handles in-place migrations of K8s resourcesâ€”specifically CronJobsâ€”to adjust to new requirements (e.g., timezone fixes). It batches pending migrations, tracks each recordâ€™s status, performs per-release K8s operations via Mizzen, and retries failures according to config.

### ðŸ› ï¸ Purpose

This service ensures that existing CronJobs across all app environments are:

- Redeployed with updated manifests to apply timezone changes
- Cleaned up if marked as undeployed
- Recorded in the database with migration status

It decouples migration logic from the main HTTP API, allowing it to run as a **standalone cron job** or at startup.

---

## Key Components

| Component | Responsibility |
| --- | --- |
| **resourceMigrator** | Orchestrates end-to-end migration: batching, per-release migration, retries |
| **K8sResourceMigrationRepository** | Persists migration records to `k8s_resource_migrations` table |
| **AppEnvService** | Provides application environment operations (e.g., `SyncReleaseManifests`) |
| **MizzenClient** | Queries and deletes K8s resources via the control-plane service |
| **Config (****`config.K8sResourceMigration`****)** | Toggles features and controls batch sizes / intervals |


---

## Data Model

```go
type K8sResourceMigration struct {
  Id               int                    `gorm:"id"`
  CreatedAt        time.Time              `gorm:"created_at"`
  AppEnvironmentId common.UniqueIdentifier `gorm:"app_environment_id"`
  Type             string                 `gorm:"type"`
  Status           string                 `gorm:"status"`
  RetryCount       int                    `gorm:"retry_count"`
}
```

Migration types and statuses:

| Type | Status |
| --- | --- |
| `CRON_TIMEZONE_MIGRATION` | PENDING |
| COMPLETE |
| FAILED |


---

## Configuration

```go
// in config struct
K8sResourceMigration = K8sResourceMigration{
  CronjobTimezoneMigrationEnabled:    getEnvAsBool(...),
  CronjobTimezoneMigrationRetryCount: getEnvAsZeroOrPositiveInt(...),
  MigrationBatchSize:                 getEnvAsZeroOrPositiveInt(...),
  MigrationIntervalSeconds:           getEnvAsZeroOrPositiveInt(...),
}
```

- **CronjobTimezoneMigrationEnabled**: toggles migration feature
- **MigrationBatchSize**: number of releases per batch
- **MigrationIntervalSeconds**: pause between batches
- **CronjobTimezoneMigrationRetryCount**: max retry attempts

---

## Invocation & Integration

The migrator runs as a **cronâ€style startup task**. In `main.go`, the `-k8s-resource-migrate` flag triggers it:

```go
if *k8sResourceMigrateFlag {
  correlationId := fmt.Sprintf("k8s-resource-migrate-%d", time.Now().Unix())
  ctx := context.WithValue(context.Background(), middleware.RequestIDKey, correlationId)
  err := resource_migrator.Migrate(ctx, cfg.K8sResourceMigration)
  if err != nil {
    logrus.Fatal(err)
  }
  return
}
```

---

## Batch Migration Process

1. **Initialization**
2. Load last migrated `AppEnvironmentId` via `GetLatest(...)`.
3. **Fetch Pending Releases**
4. Call `app.AppEnvRepository.GetCronJobsForK8sTimezoneMigration(ctx, limit, lastReleaseId)`.
5. **Perâ€Batch Loop**
6. For each release in batch:
7. Invoke `MigrateCronJob(...)`
8. On error, abort and return
9. Sleep for `MigrationIntervalSeconds`
10. **Retries**
11. After all batches, call `RetryFailedMigrations(...)` to reprocess failed entries

```mermaid
flowchart LR
  A[Start Migrate] --> B[MigrateCronJobs]
  B --> C[GetLatest MigrationRecord]
  B --> D[GetCronJobsForMigration]
  D --> E{Batch Empty?}
  E -- no --> F[MigrateCronJob per Release]
  F --> G[CreateOrUpdateMigrationRecord]
  G --> H[Next Release]
  H --> E
  E -- yes --> I[RetryFailedMigrations]
  I --> J[GetReleasesToRetry]
  J --> K[MigrateCronJob (Retry)]
  K --> L[UpdateById]
  L --> J
  J -- none --> M[Done]
```

---

## Individual Resource Migration Flow

```go
func (r *resourceMigrator) MigrateCronJob(
  ctx context.Context,
  migrationId int,
  prevRetries int,
  release app.ReleasesForK8sTimezoneMigration,
  cfg config.K8sResourceMigration,
  isFailedRetry bool,
) error { â€¦ }
```

1. **Fetch K8s Target**
2. `EnvironmentRepository.GetEnvK8sTarget`
3. **Skip Conditions**
4. Empty timezone â†’ mark COMPLETE
5. `release.Undeployed` â†’ delete CronJob via `DeleteResource` and mark COMPLETE
6. **Validate Entities**
7. App exists (`GetAppById`)
8. Project component exists (`ProjectManager().GetComponentByComponentId`)
9. **Cluster Query**
10. `MizzenQueryV2` â†’
11. 404 â†’ skip
12. 408 â†’ fail or skip based on `IsPdp`
13. **Redeploy**
14. `appEnvSvc.SyncReleaseManifests` with `WorkloadManifestSyncOpts{Msg: "Redeploying cronjob with k8s timezone migration"}`
15. **Record Outcome**
16. On success â†’ record COMPLETE
17. On error â†’ record FAILED

---

## Repository Methods

| Method | Description |
| --- | --- |
| `CreateNew(ctx, appEnvId, type, status, retryCount)` | Inserts a new migration record |
| `GetLatest(ctx, type)` | Fetches most recent record by ID desc |
| `GetReleasesToRetry(ctx, type, batchSize, maxRetries, offsetId)` | Selects FAILED records under `maxRetries` for retry |
| `UpdateById(ctx, id, status, retryCount)` | Updates status & increments retryCount |


---

This service encapsulates complex migration logic, ensuring safe, observable, and retryable CronJob transformations across all environments.
### 18.3 Shell Migration Runbooks

This section covers the **shell-based migration runbooks** for:

- ðŸ“¦ **Build/Deploy Separation**
- ðŸ”„ **MI (Micro Integrator) Configuration Migration**

Each runbook is a pair of scriptsâ€”`migrate.sh` and `revert.sh`â€”that automate resource discovery, batching, invocation of internal admin endpoints, and rollback strategies.

---

#### 18.3.1 Build/Deploy Separation Migration Scripts ðŸš€

These scripts decouple the build and deploy phases for non-mediation components, invoking Rudderâ€™s internal admin endpoints in batches.

**Scripts**

- `migration-scripts/build-deploy-seperation/migrate.sh`
- `migration-scripts/build-deploy-seperation/revert.sh`

**Workflow Overview**

```flowchart
    subgraph Discovery
      A[Start] --> B[GET older components<br/>/internal/admin/get-build-deploy-migration-older-components/{orgId}]
      B --> C{HTTP 200?}
      C -- No --> D[Exit with error]
      C -- Yes --> E[Parse CSV of OrganizationId,ComponentId]
    end

    subgraph Migration
      E --> F[Batch component IDs<br/>(batch_size=500)]
      F --> G[POST migrate-build-deploy-seperation]
      G --> H[Log response]
      H --> I[Next batch]
    end

    subgraph Rollback
      A2[Start Revert] --> B2[Read backup CSV]
      B2 --> C2[Batch component IDs]
      C2 --> D2[POST migrate-build-deploy-seperation with disable=true]
      D2 --> E2[Log response]
    end
```

**1. migrate.sh**

- **Purpose**: Fetch components needing separation, then trigger a dry-run build process via the `ADMIN_MIGRATE_BUILD_DEPLOY_SEPERATION` endpoint.
- **Key variables**:

| Variable | Description |
| --- | --- |
| `ALL_ORGS` | Boolean flag (`--all-orgs`) to include all organizations |
| `org_uuid` | Target organization UUID or all-zero for all orgs |
| `rudder_base_url` | `http://localhost:3002/internal/admin` |
| `batch_size` | Number of components per POST (default 500) |


- **Endpoints called**:
- GET `/internal/admin/get-build-deploy-migration-older-components/{orgId}?all_orgs={ALL_ORGS}`
- POST `/internal/admin/migrate-build-deploy-seperation` with JSON body:

```json
    {
      "organization_id": ["<org_uuid>"],
      "component_id": [ ...batch of component IDs... ]
    }
```

- **Batching**: Splits the list into groups of 500 IDs.

```bash
#!/bin/bash
rudder_base_url="http://localhost:3002/internal/admin"
# Discover older components
get_older_component_url="$rudder_base_url/get-build-deploy-migration-older-components/$org_uuid?all_orgs=$ALL_ORGS"
# Batch POST to migrate endpoint
migrate_url="$rudder_base_url/migrate-build-deploy-seperation"
# Function send_post_request() { ... }
# Loop over batches of 500 IDs
```

**2. revert.sh**

- **Purpose**: Roll back separation by disabling the feature flag on components.
- **Key variables**:

| Variable | Description |
| --- | --- |
| `EMPTY_UUID` | `00000000-0000-0000-0000-000000000000` org UUID |
| `revert_url` | Same as migrate URL |


- **Endpoints called**:
- POST `/internal/admin/migrate-build-deploy-seperation` with:

```json
    {
      "organization_id": ["00000000-0000-0000-0000-000000000000"],
      "component_id": [...batch...],
      "disable": true
    }
```

- **Batching**: Same 500-ID grouping as migration.

```bash
#!/bin/bash
rudder_base_url="http://localhost:3002/internal/admin"
revert_url="$rudder_base_url/migrate-build-deploy-seperation"
# Read CSV, batch IDs, and POST with disable=true
```

---

#### 18.3.2 MI Configuration Migration Scripts ðŸ”§

These scripts migrate Micro Integrator (MI) component configurations by querying the database and invoking an internal admin API per component.

**Scripts**

- `migration-scripts/mi-config-migration/migrate.sh`
- `migration-scripts/mi-config-migration/revert.sh`

**Workflow Overview**

```flowchart
    A[Validate ENV and Inputs]
    A --> B[Query MSSQL for MI components]
    B --> C{Components found?}
    C -- No --> D[Exit]
    C -- Yes --> E[For each component:]
    E --> F[POST /internal/admin/migrate-mi-component-configs/{componentId}]
    F --> G[Log success or failure]
    G --> H[Sleep 2s]
    H --> E
```

**1. migrate.sh**

- **Purpose**: Identify MI components lacking unified config mapping, then trigger their config migration.
- **Required ENV variables**:

| Name | Purpose |
| --- | --- |
| `MSSQL_HOST` | Database host |
| `MSSQL_USER` | DB user |
| `MSSQL_PASSWORD` | DB password |
| `MSSQL_DATABASE` | Database name |


- **Behavior**:
- Builds a SQL `IN` clause from `<comma-separated-org-ids>`.
- Runs `sqlcmd` to export component list to CSV.
- Iterates CSV lines, then for each `component_id`:

```bash
    response=$(curl -s -w "\n%{http_code}" -X POST \
      "http://localhost:3002/internal/admin/migrate-mi-component-configs/$component_id")
```

- Sleeps **2 seconds** between calls.
- **Endpoint called**:
- POST `/internal/admin/migrate-mi-component-configs/{componentId}`

```bash
#!/bin/bash
# ENV check
if [ -z "$MSSQL_HOST" ] || [ -z "$MSSQL_USER" ] || ...; then exit 1; fi
# SQL query to fetch MI components
sqlcmd -S "$MSSQL_HOST" -U "$MSSQL_USER" -P "$MSSQL_PASSWORD" ...
# Loop CSV, POST per component, log, sleep 2s
```

- **Integration**: This script drives the `ConfigMigrationService.MigrateMIConfigsForComponent` logic in `internal/services/config_migrator/migrator.go`, which:
- Fetches existing env vars and secrets.
- Calls `MigrateMIConfigForRelease` for each release.
- Updates `is_unified_config_mapping` flag upon success.

**2. revert.sh**

- **Purpose**: Undo unified config mapping flag in database for a set of components.
- **Required ENV variables**: Same as `migrate.sh`.
- **Behavior**:
- Reads a migration CSV (or filters it by org UUIDs).
- Collects `component_id` values.
- Constructs and executes:

```sql
    UPDATE apps
    SET is_unified_config_mapping = 0
    WHERE id IN ('<comp1>','<comp2>',...);
```

- Cleans up temporary files.
- **Rollback strategy**: Direct DB update, no API calls.
- **Batching**: Single UPDATE for all IDs.

```bash
#!/bin/bash
# Validate data file
# Extract component_ids array
formatted_ids=$(printf "'%s'," "${component_ids[@]}")
sqlcmd -S "$MSSQL_HOST" -U "$MSSQL_USER" -P "$MSSQL_PASSWORD" \
  -d "$MSSQL_DATABASE" \
  -Q "UPDATE apps SET is_unified_config_mapping = 0 WHERE id IN ($formatted_ids);"
```

---

These shell runbooks provide operators a scripted way to drive large-scale migrations, leveraging Rudderâ€™s internal admin APIs and direct database updates, while supporting batching, logging, and reversibility.
## 5. Environment, Namespace, and Cluster Management (Environment Domain + Env Sample Data)

This section covers the core data model and operations for managing Choreo  entities within Rudder. It describes how environments are created, read, updated, and disabled (“CRUD”), how to query them by organization/project/namespace, and the rules for identifying  environments.

---

### 5.1 Environment CRUD, querying, and critical-environment rules

Rudder’s environment domain encapsulates the lifecycle of deployment targets (namespaces on clusters) organized under organizations and projects. Environments may be marked “critical” (e.g. production) or non-critical, influencing promotion and metric calculations.

#### 5.1.1 Environment Data Model

The `EnvironmentRequest` struct defines the input payload for create/update operations. The persisted `Environment` embeds metadata and associations:

| Field | Type | Description |
| --- | --- | --- |
| **ID** | *common.UniqueIdentifier | UUID of the environment (optional on create) |
| **Name** | string | Logical name (e.g. “Development”) |
| **OrganizationID** | common.ChoreoOrgID | Owning organization UUID |
| **ProjectID** | common.ChoreoProjectID | Owning project UUID |
| **Description** | string | Free-form description |
| **Namespace** | string | Kubernetes namespace name |
| **Critical** | *bool | Explicit critical flag |
| **AutomaticMaintainance** | *bool | Reserved for automated maintenance |
| **AppSelector** | common.PostgresMapStringString | App label selector |
| **PromoteFrom** | common.PostgresStringArray | Ordered list of predecessor env IDs for promotion |
| **ApimEnvId** | string | External APIM environment identifier |
| **XMetadata**, **XName**, **XPlatformerData**, **Base** (embedded) | — | Common metadata, timestamps, and name fields |


Each `Environment` also preloads:

- **EnvironmentClusters**: Associations to clusters and per-cluster namespace configurations.
- **Namespaces**: Kubernetes `Namespace` objects tied to this environment.

#### 5.1.2 CRUD Operations

- **Create**

New environments are created via `Environment.Save(ctx)`, which invokes GORM’s `Create`. A `BeforeCreate` hook sets default values (`Disabled=false`, `Critical=false`, `CiliumEnabled=true`).

- **Read**
- Single by ID:

`EnvironmentRepository.EnvironmentById(ctx, id, PreloadClusters, PreloadNamespaces)` fetches an environment with its clusters and namespaces  .

- List:

The handler `GetEnvironmentsList(ctx, query)` inspects `query.ProjectID`:

- If set, calls `ProjectEnvironmentList`, otherwise `OrgSharedEnvironmentList`.
- Applies `filters.Disabled` based on the `disabled` query parameter.
- Optionally preloads clusters via `include=environment_clusters`.
- Sorts results by promotion graph or name (`SortEnvironments`) .

- **Update / Disable**

Disabling is a soft delete:

```go
  svc.DisableEnvironment(ctx, env)
  // internally:
  update := EnvPatch{Disabled: common.BoolPointer(true)}
  EnvironmentRepository.UpdateEnvironmentById(ctx, env.ID, update)
```

This marks `Disabled=true` without removing records .

- **Delete**

Full deletion occurs only during project teardown: the choreo controller’s `DeleteProjectResources`:

1. Fetches active project environments.
2. Disables each environment.
3. Removes associated namespaces in clusters.
4. Deletes DB records via `DeleteEnvironmentById`.

All errors are collected and reported.

#### 5.1.3 Querying Environments

- **Filtering**
- By organization (`OrganizationID` required)
- By project (`ProjectID` optional)
- By disabled state (`disabled=true|false|all`)
- By inclusion of related clusters/namespaces (`include` query param)

- **Namespace Lookup**
- `GetOrgProjectByNamespace(ctx, namespace)` returns the owning org and project for a given Kubernetes namespace via a raw SQL lookup on `environments.namespace` .

- **Cluster & Namespaces Listing**
- `GetOrgClusterAndNamespaces(ctx, orgId, query)` returns a list of `{ Name, Clusters[], Namespaces[] }` for all active project environments under an org .

- **Sorting**

Environments are ordered by promotion relationships: if A promotes to B, A precedes B; otherwise alphabetical order. Built from each `env.PromoteFrom` array .

#### 5.1.4 Critical-Environment Rules

Environments may be  for operational visibility (e.g. production):

- **Derivation**

```go
  func IsCriticalEnv(env Environment) bool {
    if env.ChoreoEnv == common.ChoreoDefaultEnvProd { return true }
    return env.Critical != nil && *env.Critical
  }
```

Production (`ChoreoEnv == "prod"`) is always critical; otherwise uses the `Critical` flag .

- **Querying Critical Info**
- By **Environment ID**: `EnvCriticalInfoByEnvId` selects `id, name, critical, org_id, project_id, template_id` where `disabled=0` .
- By **Release ID**: `EnvCriticalInfoByReleaseId` joins `app_environments` to map a release back to its environment .
- By **Project**: `EnvCriticalInfoForProject` returns an array of `{ env_id, env_name, critical, env_template_id }` for all active environments in a project .

- **Validation Logic**

`GetEnvironmentByIdOrRelease(ctx, query)` enforces:

1. `OrganizationID` must be non-empty.
2. At least one of `EnvID` or `ReleaseID` is provided.
3. If `ReleaseID` is set, fetch critical info by release; if `EnvID` also set, ensure it matches the derived env ID.
4. If only `EnvID`, fetch critical info by env.
5. Validate the returned `OrganizationId` and optional `ProjectID` match the query; otherwise return a `BadRequestError` .

- **Controller Endpoints**
- **Get critical info**
- `/environments/{uuid}/critical?release_id=…` → `ChoreoEnvironmentCriticalInfoByIdOrRelease`
- `/projects/environments/critical?organization_id=…&project_id=…` → `ChoreoEnvironmentCriticalInfoByProject`
- `/organizations/{uuid}/environments/distinct‐critical?org_int_id=…` → `DistinctCriticalEnvs` (ensures uniqueness by name)

---

### Example Env Sample Data

Below is a typical JSON payload illustrating two environments with a promotion chain:

```json
[
  {
    "ID": "4635861f-9111-4dd7-a248-26801be1d5cc",
    "name": "Production",
    "organization_id": "3191cd25-ec96-4bd0-868a-2a4eeba3ada6",
    "promote_from": [
      "6e10e24c-6aac-43c9-940e-871292b5f136"
    ]
  },
  {
    "ID": "6e10e24c-6aac-43c9-940e871292b5f136",
    "name": "Development",
    "organization_id": "3191cd25-ec96-4bd0-868a-2a4eeba3ada6",
    "promote_from": []
  }
]
```

Found in `internal/bundles/environment/env_sample_data/env_list_5.json`.

---

✨ This completes the in-depth view of how Rudder manages Environment entities, supports flexible querying, and enforces critical-environment rules in its Go HTTP API.
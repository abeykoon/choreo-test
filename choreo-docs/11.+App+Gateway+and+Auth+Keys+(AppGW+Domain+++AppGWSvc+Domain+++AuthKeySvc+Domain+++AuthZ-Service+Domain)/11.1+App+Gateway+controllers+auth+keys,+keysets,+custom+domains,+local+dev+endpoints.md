# 11. App Gateway and Auth Keys

This section covers the App Gateway‚Äìrelated controllers responsible for managing authentication keys, key sets, custom domains, and local development endpoints. These controllers sit in the `choreo/bundles/app/appgw` package and wire HTTP requests (via handlers in `choreo/handlers`) to underlying services in `appgwsvc` and `authkeysvc`.

| Controller | Responsibility | Key Methods |
| --- | --- | --- |
| **AuthKeysController** üîë | CRUD operations on OAuth authentication keys | CreateAuthKeys, GenerateAuthKeys, RegenerateAuthKeys, DeleteAuthKeys |
| **KeySetController** üóùÔ∏è | Manage key‚Äêset configurations and trigger gateway updates | CreateKeySet, GenerateKeySet, RegenerateKey, DeleteKeySet |
| **CustomDomainController** üåê | Add or remove custom domains in App Gateway | AddCustomDomain, DeleteCustomDomain |
| **LocalDevelopmentController** üõ† | Configure local OAuth callback URLs for development | UpdateLocalDevelopmentConfigs, GetLocalDevelopmentConfigs |


---

## 11.1 AuthKeysController

The **AuthKeysController** defines how HTTP handlers invoke auth‚Äêkey operations:

```go
type AuthKeysController interface {
  CreateAuthKeys(ctx context.Context, params authkeysvc.AuthKeySet,
    env *environment.Environment, componentId common.UniqueIdentifier,
    projectUuid, orgUuid, keyType string) (bool, error)
  GenerateAuthKeys(ctx context.Context, params authkeysvc.KeySetGenerateRequest,
    env *environment.Environment, componentId common.UniqueIdentifier,
    projectUuid, orgUuid, keyType string) (*authkeysvc.OAuthAppResponse, error)
  RegenerateAuthKeys(ctx context.Context, params authkeysvc.KeySetRegenerateRequest,
    env *environment.Environment, componentId common.UniqueIdentifier,
    projectUuid, orgUuid string) (*authkeysvc.OAuthAppResponse, error)
  DeleteAuthKeys(ctx context.Context, componentId common.UniqueIdentifier,
    projectUuid, orgUuid string) []error
}
```

**Implementation highlights**

- Retrieves the component metadata via Project Manager.
- Enforces presence of APIM App ID metadata.
- Delegates to `authkeysvc.AuthKeysService` for key creation/generation/regeneration.
- On deletion, collects errors from deleting all OAuth apps and cleaning up configuration groups.

---

## 11.2 KeySetController

The **KeySetController** manages key‚Äêset lifecycle and triggers App Gateway updates:

```go
type KeySetController interface {
  CreateKeySet(ctx context.Context, body authkeysvc.AuthKeySet,
    env *environment.Environment, app *app.App, skipAppGatewayConfigUpdate bool) (bool, error)
  GenerateKeySet(ctx context.Context, params authkeysvc.KeySetGenerateRequest,
    env *environment.Environment, application *app.App,
    skipAppGatewayConfigUpdate bool) (*authkeysvc.OAuthAppResponse, error)
  RegenerateKey(ctx context.Context, params authkeysvc.KeySetRegenerateRequest,
    env *environment.Environment, application *app.App) (*authkeysvc.OAuthAppResponse, error)
  DeleteKeySet(ctx context.Context, application app.App) []error
  DeleteKeySetAndAppGWResourcesByDeploymentTrackId(ctx context.Context,
    application app.App, deploymentTrackId common.UniqueIdentifier) error
}
```

**Key patterns**

- Fetches or creates the ‚Äúapp-gw-key-sets‚Äù configuration group via the Configuration Management client.
- Uses `authkeysvc.AuthKeysService` to generate or regenerate keys.
- Calls `appgwsvc.AppGatewayService.UpdateAuthenticationGatewayConfigs` to push updated OAuth client settings (redirect URIs, scopes, etc.) to the data plane.
- Orchestrates cleanup of keys and gateway resources on delete.

---

## 11.3 CustomDomainController

The **CustomDomainController** exposes endpoints for setting or unsetting custom domains:

```go
type CustomDomainController interface {
  AddCustomDomain(ctx context.Context, req CustomDomainConfig,
    componentId, environmentId, deploymentTrackId common.UniqueIdentifier) error
  DeleteCustomDomain(ctx context.Context, req CustomDomainConfig,
    componentId, environmentId, deploymentTrackId common.UniqueIdentifier) error
}

type CustomDomainConfig struct {
  CustomDomainName string ` + "`json:\"customDomain\"`" + `
}
```

**Flow**

1. Resolve the `app.Environment` for the given `componentId`, `environmentId`, and `deploymentTrackId`.
2. Call into `appgwsvc.AppGatewayService`‚Äôs `AddCustomDomain` or `DeleteCustomDomain`, which:
3. Determines if App Gateway is enabled via the ‚Äúapp-gw-auth-configs‚Äù group.
4. Updates or removes the custom domain in the OAuth Agent and gateway manifests.

---

## 11.4 LocalDevelopmentController

The **LocalDevelopmentController** handles dev‚Äêonly OAuth callback URL configuration:

```go
type LocalDevelopmentController interface {
  UpdateLocalDevelopmentConfigs(ctx context.Context, req LocalDevConfig,
    release *app.AppEnvironment) error
  GetLocalDevelopmentConfigs(ctx context.Context,
    release *app.AppEnvironment) (LocalDevConfig, error)
}

type LocalDevConfig struct {
  Enable      bool     ` + "`json:\"enable\"`" + `
  AllowedUris []string ` + "`json:\"allowedUris\"`" + `
}
```

**Responsibilities**

- **Validation**: rejects requests for critical environments or non-web apps.
- **Config groups**: reads/writes the ‚Äúapp-gw-local-dev-configs‚Äù group scoped by deployment track and template.
- **URI handling**: deduplicates and validates each URI; computes login/logout callback URLs.
- **Gateway update**: pushes allowed paths to the OAuth Agent via `appGatewayOAuthAgentService.UpdateConfigurations`.

---

These controllers tie the HTTP surface to the App Gateway and Auth Key services, ensuring consistent management of OAuth credentials, custom domains, and local development flows within the Choreo data-plane.
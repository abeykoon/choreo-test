## 11.2 App Gateway Service Layer

The **App Gateway service layer** in `choreo/bundles/app/appgwsvc` orchestrates two key concerns for web-app traffic: cleaning up App Gateway entries in **Redis**, and managing OAuth configurations via the **OAuth Agent**. It exposes a single `AppGatewayService` implementation that coordinates with external clients (Redis, Mizzen, STS management) and internal utilities.

---

### Core Components

| File | Responsibility |
| --- | --- |
| **app_gateway_service.go** | Implements `AppGatewayService` interface; entry point for operations. |
| **application_gateway.go** | Defines keys used in App Gateway configs (issuer, paths, scopes). |
| **app_gateway_utils.go** | Utility functions: release ID extraction, path constants. |
| **AppGatewayOAuthAgentService** | Abstracts HTTP calls to the OAuth Agent (via Mizzen proxy). |
| **Redis cleanup methods** | In `app_gateway_service.go`, methods to delete Redis entries. |


---

## üîÑ Redis Integration

When an application or specific deployment track is removed, the service must clear stale App Gateway entries in Redis. Two methods handle this:

1. **DeleteAppGWRedisEntriesOfComponent**
2. Triggered on full component deletion.
3. Fetches all non-PDP releases; groups them by cluster.
4. Calls `DeleteAllConfigurations` on the OAuth Agent (to clear Agent state)

and then deletes Redis ingress entries per cluster.

1. **DeleteAppGWRedisIngressEntriesByDeploymentTrackID**
2. Triggered when removing a single deployment track.
3. Fetches releases for that track; delegates to `deleteRedisIngressEntriesForReleases`.

#### Key Helper

```go
// Build list of Redis keys per release (ID and optional short URL)
func getRedisKeysList(release app.ReleaseShortUrlWithClusterId) []string {
    redisKeys := []string{ release.Id.String() }
    if release.CdpShortUrlName != "" {
        redisKeys = append(redisKeys, release.CdpShortUrlName)
    }
    return redisKeys
}
```

Referenced in deletion loop .

#### Deletion Loop

```go
func (c *appGatewayService) deleteRedisIngressEntriesForReleases(
    ctx context.Context,
    releases []app.ReleaseShortUrlWithClusterId,
    logger *logctx.CtxLogger,
) error {
    var errList []error
    for _, release := range releases {
        redisKeys := getRedisKeysList(release)
        if err := c.clients.AppGwRedisClient().
            DeleteIngressEntries(ctx, release.ClusterId, redisKeys...); err != nil {
            appGwRedisErr := fmt.Errorf(
                "failed to delete App GW redis entries on dp %s: %w",
                release.ClusterId, err,
            )
            errList = append(errList, appGwRedisErr)
        }
    }
    if len(errList) > 0 {
        return fmt.Errorf("failed to delete App GW from redis: %v", errors.Join(errList...))
    }
    logger.Infof("Redis entries related to App Gateway feature deleted")
    return nil
}
```

---

## üîê OAuth Agent Service

The service delegates managed-auth configuration operations to an **OAuth Agent** via the `AppGatewayOAuthAgentService` interface. This abstracts HTTP calls through Mizzen, ensuring consistent proxying and correlation IDs.

### Interface Methods

- `UpdateConfigurations(ctx, clusterId, releaseId, configs)`

Sets or updates managed-auth configs for a release.

- `DeleteConfigurations(ctx, clusterId, releaseId, configNames)`

Deletes specific config keys.

- `DeleteAllConfigurations(ctx, clusterId, releaseIds)`

Clears all managed-auth configs for given releases.

### Implementation Snippet

```go
func (s *appGatewayOAuthAgentService) UpdateConfigurations(
    ctx context.Context,
    clusterId common.UniqueIdentifier,
    releaseId string,
    configurations map[string]interface{},
) error {
    req := ManagedAuthConfigurationUpdateRequest{
        ReleaseId:      releaseId,
        Configurations: configurations,
    }
    correlationId := common.NewUUID().String()
    headers := map[string]string{"x-correlation-id": correlationId}
    url := fmt.Sprintf("%s/internal/managed-auth/configurations/set",
        config.GetConfig().OAuthAgentServiceUrl)
    proxy := mizzen.ProxyHttpRequest{
        URL:       url,
        ClusterID: clusterId,
        Method:    "POST",
        Headers:   headers,
        Body:      req,
        JSON:      true,
    }
    if _, err := s.clients.MizzenClient().ProxyUserApp(ctx, proxy); err != nil {
        return fmt.Errorf("failed to set configurations in oauth agent: %w, correlation-id: %s",
            err, correlationId)
    }
    return nil
}
```

Full implementation of `DeleteConfigurations` and `DeleteAllConfigurations` follows the same pattern .

---

## üõ†Ô∏è Utility Functions

- **GetReleaseIdFromRelease** / **GetReleaseIdFromReleaseShortUrlWithClusterId**

Compute the release identifier used in App Gateway (prefers short URL when present).

- **updateCallBackUrls**

Uses the STS management client to add/remove login/logout callback URLs on the OAuth App.

```go
func (c *appGatewayService) updateCallBackUrls(
    ctx context.Context,
    webappUrl, previousWebappUrl, clientId, orgId, envId string,
) error {
    toRemove := getCallbackUrls(previousWebappUrl)
    toAdd    := getCallbackUrls(webappUrl)
    req := &apim.UpdateOAuthAppCallbackRequest{ Add: toAdd, Remove: toRemove }
    logctx.GetLogger(ctx).Infoln("APP_GW :: Updating callback urls.", req)
    return c.clients.STSManagementClient().
        UpdateCallBackUrls(ctx, clientId, req, orgId, envId)
}
```

Callback URL helper:

```go
func getCallbackUrls(webappUrl string) []string {
    base := webappUrl
    if !strings.HasPrefix(webappUrl, "https://") {
        base = "https://" + webappUrl
    }
    return []string{
        fmt.Sprintf("%s/auth/login/callback",  base),
        fmt.Sprintf("%s/auth/logout/callback", base),
    }
}
```

---

By centralizing Redis cleanup and OAuth Agent operations behind a single service, the Rudder App Gateway layer ensures consistent, clustered cleanup of ingress entries and robust management of OAuth configurations across all Choreo data-plane environments.
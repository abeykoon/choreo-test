# 19. Database Layer (MSSQL Migrations Domain)

This section covers the **migration framework**, how migrations are **registered**, and how you can **run them locally** in the Rudder service. It explains the gormigrate-based registration pattern, ordering strategy, and provides guidelines for authoring safe, reversible migrations.

## 19.1 Migration framework, registration pattern, and local execution

MSSQL migrations in Rudder live under `database/mssql_migrations`. The project uses [go-gormigrate](https://github.com/go-gormigrate/gormigrate) to track and apply schema changes in sequence.

### Migration framework

- **Migration list**

A global slice `migrationList []*gormigrate.Migration` holds all registered migrations.

- **RegisterMigration**

Each migration file calls `RegisterMigration(migration)` in its `init()` to append itself.

- **Ordering**

File names are prefixed with three-digit version numbers (e.g. `047_‚Ä¶`, `084_‚Ä¶`). `init()` functions execute in lexical order, ensuring migrations run in ascending ID order.

- **ToVersion**

The function `ToVersion(db, version)` validates ID order and invokes `gormigrate.MigrateTo(version)` to apply up (or down) migrations.

- **isInOrder**

A regex enforces the ID format `^0\.0\.(\d+)$`; it ensures no gaps or duplicates before running.

```go
// in database/mssql_migrations/migrate.go
func RegisterMigration(migration gormigrate.Migration) { /* appends to migrationList */ }
func ToVersion(db *gorm.DB, version string) error { /* runs migrations to given version */ }
```

### Registration pattern

Every file in `database/mssql_migrations` follows this structure:

| File | ID | Migrate action | Rollback defined |
| --- | --- | --- | --- |
| 047_domain_environment.go | 0.0.47 | `tx.AutoMigrate(&CustomDomain{})` | Yes |
| 084_domain_env_fk.go | 0.0.84 | `db.Exec(‚Ä¶alter table‚Ä¶)` | No |
| 122_release_cdp_webapp_name.go | 0.0.122 | `tx.Transaction(runSQL(...))` | Yes |
| 148_add_region_to_cilium_org.go | 0.0.148 | `db.Transaction(runSQL(...))` | Yes |


- **ID**

Matches the file prefix.

- **Logging**

`logrus.Info("Initialize Migration Script XXX")` in `init()`, and again at runtime.

- **SQL vs AutoMigrate**
- Use raw SQL strings with `runSQL(tx, ‚Ä¶)` inside `tx.Transaction` for multi-statement changes.
- Use `tx.AutoMigrate(&Type{})` for simple schema evolutions.
- **Rollback**

Where provided, the `Rollback` function reverts the change (e.g. dropping columns or tables).

#### Example: adding a foreign key

```go
// 084_domain_env_fk.go
func init() {
  logrus.Info("Initialize Migration Script 084")
  fk := `alter table custom_domains
         add constraint custom_domains_environments_id_fk
         foreign key (environment_id) references environments`
  RegisterMigration(gormigrate.Migration{
    ID: "0.0.84",
    Migrate: func(db *gorm.DB) error {
      logrus.Info("Running Migration Script 084")
      return db.Exec(fk).Error
    },
  })
}
```

#### Example: AutoMigrate with rollback

```go
// 047_domain_environment.go
func init() {
  logrus.Info("Initialize Migration Script 047")
  type CustomDomain struct {
    EnvironmentID UniqueIdentifier `gorm:"type:uniqueidentifier;"`
  }
  RegisterMigration(gormigrate.Migration{
    ID: "0.0.47",
    Migrate: func(tx *gorm.DB) error {
      return tx.AutoMigrate(&CustomDomain{})
    },
    Rollback: func(tx *gorm.DB) error {
      return tx.Migrator().DropColumn(&CustomDomain{}, "environment_id")
    },
  })
}
```

### Execution flow

```mermaid
flowchart TD
  subgraph Init
    A1[047_‚Ä¶ .go init] -->|RegisterMigration| B[MigrationList]
    A2[084_‚Ä¶ .go init] -->|RegisterMigration| B
    A3[122_‚Ä¶ .go init] -->|RegisterMigration| B
  end
  B --> C[gormigrate.New(db, DefaultOptions, MigrationList)]
  C --> D[MigrateTo(targetVersion)]
```

### Local execution

‚öôÔ∏è **scripts/migrate.sh**

A shell script `scripts/migrate.sh` wraps the call to the migration runner. Typical usage:

```bash
# Apply all pending migrations
./scripts/migrate.sh

# Or migrate to a specific version
./scripts/migrate.sh 0.0.122
```

üì¶ **Makefile target**

```make
.PHONY: migrate
migrate: ## Run db migrations
    sh scripts/migrate.sh
```

Run via:

```bash
make migrate
```

### Guidelines for safe migrations

- **Transactions**

Wrap multi-statement SQL in `db.Transaction(func(tx) { ‚Ä¶ })` to ensure atomicity.

- **Rollback strategy**

Provide a `Rollback` function whenever possible to drop added columns, indices, or tables.

- **Naming & versioning**
- File names must start with a three-digit sequence matching the migration ID (e.g. `054_‚Ä¶` for ID `0.0.54`).
- IDs follow the `0.0.<number>` pattern; gaps or duplicates cause `isInOrder` to error.
- **runSQL utility**

Use the shared `runSQL(tx, statements...)` helper to execute multiple SQL commands in order.

- **Logging**

Always include `logrus.Info` at init and before executing migrations for traceability.

---

By following this pattern, Rudder‚Äôs SQL Server schema evolves in a controlled, reversible, and well-logged manner.
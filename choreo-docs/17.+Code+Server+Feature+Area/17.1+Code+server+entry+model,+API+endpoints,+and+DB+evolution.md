# 17. Code Server Feature Area

This section covers the **Code Server** feature in Rudder, focusing on the data model for code-server entries, its HTTP API surface, and the evolution of the underlying SQL schema through migrations.

## 17.1 Code Server Entry Model

The `CodeServerEntry` struct represents a persisted record of a running code-server instance. Each entry maps a userâ€™s request to a dedicated BYOI web-app component and stores metadata for subsequent updates and lookups.

**File:** `internal/bundles/app/codeserver_repository.go`

```go
type CodeServerEntry struct {
  ID                    int64                   // Primary key
  UserID                string                  // Choreo user identifier
  OrganizationID        common.ChoreoOrgID      // Owning organization
  ProjectID             common.ChoreoProjectID  // Owning project
  ComponentID           common.UniqueIdentifier // Optional source component
  ImageURL              string                  // Last deployed image URL
  URL                   string                  // Public code-server URL
  CodeServerComponentID common.UniqueIdentifier // BYOI component ID
  SourceCommitHash      string                  // Git commit hash
  EnvID                 common.UniqueIdentifier // Environment/namespace ID
}
```

### Repository Methods

- **GetByUniqueKey**: Finds an entry by `(user_id, org_id, proj_id, component_id IS NULL/=`ID`) for idempotent creates and lookups.
- **GetByCodeServerComponentID**: Retrieves an entry by its BYOI component.
- **Create**: Inserts a new entry.
- **UpdateURL** / **UpdateImageURL** / **UpdateEnv** / **UpdateCommitHash**: Partial updates of single columns.
- **UpdateSourceComponentDetails**: Associates an entry with a source component and commit.
- **ListByComponentID** / **ListByProjectID**: Fetches all code-server component IDs for UI listing.

---

## 17.2 API Endpoints

Three REST endpoints allow clients to create, update, and list code-server entries.

### POST `/api/v1/code-server/`

Creates or retrieves a code-server instance for the given parameters.

```api
{
    "title": "Create or Get Code Server",
    "description": "Creates a new code-server or returns the URL of an existing one.",
    "method": "POST",
    "baseUrl": "https://<rudder-host>/api/v1/code-server",
    "endpoint": "/",
    "headers": [
        {
            "key": "Authorization",
            "value": "Bearer <token>",
            "required": true
        }
    ],
    "queryParams": [],
    "pathParams": [],
    "bodyType": "json",
    "requestBody": "{\n  \"user_id\": \"user123\",\n  \"organization_id\": \"org-uuid\",\n  \"project_id\": \"proj-uuid\",\n  \"component_id\": \"comp-uuid\",\n  \"registry_id\": \"reg-uuid\",\n  \"image_url\": \"ghs_abc123/image:tag\",\n  \"source_commit_hash\": \"abcdef\",\n  \"deployment_track_id\": \"track-uuid\"\n}",
    "formData": [],
    "rawBody": "",
    "responses": {
        "201": {
            "description": "Created or existing URL returned",
            "body": "{ \"url\": \"https://<host>.dev?tkn=codeServerCompId\" }"
        },
        "500": {
            "description": "Server error",
            "body": "{ \"error\": { \"message\": \"...\" } }"
        }
    }
}
```

### PUT `/api/v1/code-server/source-component`

Updates the source component and commit hash for an existing entry.

```api
{
    "title": "Update Source Component Details",
    "description": "Associates an existing code-server entry with a source component and commit hash.",
    "method": "PUT",
    "baseUrl": "https://<rudder-host>/api/v1/code-server",
    "endpoint": "/source-component",
    "headers": [],
    "queryParams": [],
    "pathParams": [],
    "bodyType": "json",
    "requestBody": "{\n  \"user_id\": \"user123\",\n  \"organization_id\": \"org-uuid\",\n  \"project_id\": \"proj-uuid\",\n  \"component_id\": \"new-comp-uuid\",\n  \"source_commit_hash\": \"newhash\",\n  \"registry_id\": \"reg-uuid\",\n  \"image_url\": \"\",\n  \"deployment_track_id\": \"track-uuid\"\n}",
    "formData": [],
    "rawBody": "",
    "responses": {
        "200": {
            "description": "Updated successfully",
            "body": "null"
        },
        "400": {
            "description": "Invalid input",
            "body": "{ \"error\": { \"message\": \"...\" } }"
        },
        "500": {
            "description": "Server error",
            "body": "{ \"error\": { \"message\": \"...\" } }"
        }
    }
}
```

### GET `/api/v1/code-server/?componentId={uuid}`

Lists all code-server component IDs for a source component.

```api
{
    "title": "List Code Servers by Component",
    "description": "Retrieves all running code-server component IDs associated with the given source component.",
    "method": "GET",
    "baseUrl": "https://<rudder-host>/api/v1/code-server",
    "endpoint": "/?componentId={uuid}",
    "headers": [
        {
            "key": "Authorization",
            "value": "Bearer <token>",
            "required": true
        }
    ],
    "queryParams": [
        {
            "key": "componentId",
            "value": "Source component UUID",
            "required": true
        }
    ],
    "pathParams": [],
    "bodyType": "none",
    "requestBody": "",
    "formData": [],
    "rawBody": "",
    "responses": {
        "200": {
            "description": "List of code-server component IDs",
            "body": "[\"codeServerCompId1\",\"codeServerCompId2\"]"
        },
        "400": {
            "description": "Invalid componentId",
            "body": "{ \"error\": { \"message\": \"componentId is invalid\" } }"
        },
        "500": {
            "description": "Server error",
            "body": "{ \"error\": { \"message\": \"...\" } }"
        }
    }
}
```

---

## 17.3 Database Evolution

The **`code_server_entries`** table evolves across five migrations (208â€“212):

| Migration ID | Description |
| --- | --- |
| **208** | Create table with core columns (`user_id`, `org_id`, `project_id`, `component_id`, `image_url`, `url`, timestamps). |
| **209** | Truncate table; make some UUID columns nullable; add `codeServerComponentID`, `sourceCommitHash` and foreign keys to `apps` (`component_id`, cascade delete). |
| **210** | Rename columns to snake_case: `sourceCommitHash` â†’ `source_commit_hash`, `codeserver_component_id` â†’ `code_server_component_id`. |
| **211** | Add `env_id` column (`UNIQUEIDENTIFIER NULL`) with FK to `environments(id)` (ON DELETE SET NULL). |
| **212** | Create indices to optimize lookups:<br/>â€¢ `idx_code_server_user_org_proj_comp` on `(user_id, organization_id, project_id, component_id)`<br/>â€¢ `idx_code_server_component_id` on `(component_id)` INCLUDE `(code_server_component_id)`<br/>â€¢ `idx_code_server_project_id` on `(project_id)`. |


### Index Support

- **User/Org/Proj/Comp**: Speeds up `GetByUniqueKey` queries filtering by those four columns.
- **Component**: Optimizes `ListByComponentID` pluck queries, including the component ID for a covering index.
- **Project**: Beneficial for potential future listing by project.

```sql
-- Example (Migration 212)
CREATE INDEX idx_code_server_user_org_proj_comp
  ON code_server_entries (user_id, organization_id, project_id, component_id);

CREATE INDEX idx_code_server_component_id
  ON code_server_entries (component_id)
  INCLUDE (code_server_component_id);

CREATE INDEX idx_code_server_project_id
  ON code_server_entries (project_id);
```

---

ðŸš€ This completes the **Code Server Feature Area** documentation, detailing the entry model, HTTP API contracts, and the underlying schema migrations driving Rudderâ€™s code-server lifecycle.
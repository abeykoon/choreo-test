### 8.3 Network policies: Choreo netpol generator and Cilium-specific policies/annotations

This section describes how Rudder generates Cilium-based Kubernetes network policies, defines policy models and annotations, and integrates them with the network-policy bundles and HTTP routes. We cover:

- Choreo default netpol generator
- Cilium `NetworkPolicy` model
- Policy rules and simplified YAML output
- CiliumEnvoyConfig (CEC) types and proxy-visibility annotations
- Integration with bundles, controllers, and tests

---

#### 8.3.1 Choreo default Cilium netpol generator

Rudder‚Äôs **Choreo netpol generator** lives under `internal/generator/choreonetpols`. It provides a minimal, namespace-scoped policy that allows all intra-namespace traffic.

```go
func MakeCiliumNetworkPolicyManifests(ctx context.Context, namespace string) (
    manifests []cilium.NetworkPolicy, err error,
) {
    p := cilium.NetworkPolicy{}
    p.SetName("choreo-default-policies")
    p.SetNamespace(namespace)
    p.SetHeaders()

    // Allow all traffic within the same namespace
    p.AddRule(makeRuleAllowCommunicationWithinNamespace(namespace))

    manifests = append(manifests, p)
    return
}
```

- **SetName**, **SetNamespace**, **SetHeaders** set metadata fields in the Cilium CRD.
- **makeRuleAllowCommunicationWithinNamespace** produces a single `Rule` permitting all ingress and egress within the namespace .

```go
func makeRuleAllowCommunicationWithinNamespace(namespace string) *cilium.Rule {
    allEndpoints := cilium.EndpointSelector{MatchLabels: map[string]string{}}
    return &cilium.Rule{
        Egress: []cilium.EgressRule{{ToEndpoints: []cilium.EndpointSelector{allEndpoints}}},
        Ingress: []cilium.IngressRule{{FromEndpoints: []cilium.EndpointSelector{allEndpoints}}},
    }
}
```

---

#### 8.3.2 Simplified YAML output

The generator‚Äôs output, when rendered to YAML, looks like:

```yaml
kind: CiliumNetworkPolicy
apiVersion: cilium.io/v2
metadata:
  name: choreo-default-policies
  namespace: test-namespace
spec:
  endpointSelector: {}
  ingress:
    - fromEndpoints:
        - {}
  egress:
    - toEndpoints:
        - {}
```

This minimal policy ensures pods can freely communicate within their own namespace .

---

#### 8.3.3 Cilium `NetworkPolicy` model

Under `internal/generator/cilium/network_policy.go`, the **NetworkPolicy** struct wraps Cilium‚Äôs CRD:

| Field | Type | Description |
| --- | --- | --- |
| `TypeMeta` | `metav1.TypeMeta` | `Kind: CiliumNetworkPolicy`, `APIVersion` |
| `ObjectMeta` | `metav1.ObjectMeta` | `metadata.name`, `metadata.namespace` |
| `Spec` | `*Rule` | Single rule (deprecated once multiple added) |
| `Specs` | `[]*Rule` | List of rules for multi-rule policies |


Methods:

- **SetHeaders()** initializes `Kind` and `APIVersion`.
- **SetName(name)** sets `metadata.name`.
- **SetNamespace(ns)** sets `metadata.namespace`.
- **AddRule(rule)** appends a new `Rule`:
- If both `Spec` and `Specs` are empty, `Spec` holds the first rule.
- If `Spec` exists but `Specs` is empty, both are migrated into `Specs`.
- Further rules are simply appended to `Specs`.

```go
func (n *NetworkPolicy) AddRule(rule *Rule) {
    if len(n.Specs) == 0 {
        if n.Spec == nil {
            n.Spec = rule
            return
        }
        n.Specs = []*Rule{n.Spec, rule}
        n.Spec = nil
        return
    }
    n.Specs = append(n.Specs, rule)
}
```

üîç **Rule-adding behavior** is validated in `internal/generator/cilium/network_policy_test.go` .

---

#### 8.3.4 Cilium constants and proxy-visibility annotation

`internal/generator/cilium/constants.go` defines common match labels and the Cilium proxy-visibility annotation key:

```go
const (
  MatchLabel_PodNamespace        = "k8s:io.kubernetes.pod.namespace"
  MatchLabel_Instance            = "app.kubernetes.io/instance"
  MatchLabel_K8sApp              = "k8s-app"
  MatchLabel_AllowUserAppIngress = "userapp-ingress-allowed"
  
  // Used on Pod template to configure L7 proxy visibility
  PodAnnotation_ProxyVisibility = "policy.cilium.io/proxy-visibility"
)
```

These constants support advanced policy rules and sidecar configurations .

---

#### 8.3.5 CiliumEnvoyConfig (CEC) types ‚öôÔ∏è

To drive Cilium‚Äôs Envoy integration, Rudder emits **CiliumEnvoyConfig** CRDs under `internal/generator/cilium/cec_types.go`:

```go
// +kubebuilder:resource:... shortName={cec}
type CiliumEnvoyConfig struct {
 TypeMeta   `json:",inline"`
 ObjectMeta `json:"metadata"`
 Spec       CiliumEnvoyConfigSpec `json:"spec,omitempty"`
}
```

Helper methods in `envoy_config.go` let you set standard metadata and labels:

```go
func (c *CiliumEnvoyConfig) SetTypeMetadata() {
  c.Kind = "CiliumEnvoyConfig"
  c.APIVersion = "cilium.io/v2"
}
func (c *CiliumEnvoyConfig) SetObjectMetadata(name, namespace string) {
  c.Name = name; c.Namespace = namespace
}
func (c *CiliumEnvoyConfig) SetReleaseIdLabel(releaseId string) {
  if c.Labels == nil { c.Labels = make(map[string]string) }
  c.Labels["release_id"] = releaseId
}
```

---

#### 8.3.6 Integration with bundles and routes

1. **HTTP API**
2. Routes under `/egress` (defined in `choreo/routes/network_policy.go`) invoke handlers that CRUD **EgressPolicy** in the control plane.

1. **Bundle generator**
2. `internal/bundles/network-policy/network_policy_generator.go` translates DB `EgressPolicy` into a Cilium `NetworkPolicy`.
3. A default fallback uses `GenerateDefaultCiliumNetworkPolicy`.

1. **Deployment**
2. `internal/bundles/environment/ns_deployer.go` checks for project/org policies.
3. It then calls either `GenerateCiliumNetworkPolicy` or falls back to `GenerateDefaultCiliumNetworkPolicy`.
4. The resulting Cilium CRD is deployed via Mizzen.

1. **Background processing**
2. `internal/bundles/network-policy/network_policy_worker.go` batches environments and deploys policies in parallel after policy updates.

---

#### 8.3.7 Testing and validation

- **Choreo netpols**
- `TestMakeCiliumNetworkPolicyManifests` in `internal/generator/choreonetpols/choreo_cilium_test.go` verifies that the default policy matches the simplified YAML output and marshals correctly to JSON.

- **Cilium model**
- `TestAddRule` in `internal/generator/cilium/network_policy_test.go` covers all branches of `AddRule`, ensuring correct `Spec`/`Specs` transitions .

These tests guarantee that Rudder‚Äôs network policy generation produces valid, predictable Cilium manifests ready for deployment.
# 29.3 Developer Scripts and Makefile Entry Points

This section describes the **Makefile** targets and the accompanying `scripts/` utilities that streamline local workflows for development, testing, database migrations, code formatting, linting, and more. These tools leverage environment-variable conventions and require a few prerequisites to run smoothly.

## Prerequisites ðŸ“¦

- **Go 1.21** or higher
- **modd** (development server orchestrator)
- **moq** (mock generator)

```bash
go install github.com/cortesi/modd/cmd/modd@latest
go install github.com/matryer/moq@latest
```

(modd and moq installation commands cited from the README)

Ensure `$GOPATH/bin` is in your `PATH` so these tools are available.

---

## Makefile Targets

| Target | Description | Underlying Script |
| --- | --- | --- |
| **help** | List available commands | â€” |
| **run** ðŸš€ | Start dev server | `scripts/startdev.sh` |
| **run-cron** | Run cleanup cron job | `scripts/start_cron_mode.sh` |
| **migrate** | Apply DB migrations | `scripts/migrate.sh` |
| **fmt** âœ¨ | Format code & ensure newlines | `goimports` + `scripts/newline.sh` |
| **lint** ðŸ•µï¸â€â™€ï¸ | Run linter | `scripts/lint.sh` |
| **test** âœ… | Run unit tests & coverage | `scripts/run_tests.sh` |
| **installdeps** | Install development deps | `scripts/install_dependencies.sh` |
| **generate** | Run `go generate` & format | `go generate ./...` + `make fmt` |


 (Makefile excerpt)

---

## Environment Variables Convention

- **ENV_FILE_NAMES**: comma-separated list of `.env` files to source (e.g. `config.test.env,config.dev.env`)
- **PROJECT_ROOT_PATH**: absolute path to the project root (commonly `$(pwd)`)

Scripts reference these to load configuration consistently.

---

## scripts/install_dependencies.sh

**Purpose:** Install CLI tools needed for development.

- Installs:
- `modd` for live reloading & dev server
- `moq` for generating Go mocks
- `golangci-lint` and `goimports` for linting & formatting

```bash
go install github.com/cortesi/modd/cmd/modd@latest
go install github.com/matryer/moq@latest
go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.55.2
golangci-lint --version
go install golang.org/x/tools/cmd/goimports@latest
```

(install script)

---

## scripts/lint.sh

**Purpose:** Lint Go code and Dockerfile.

1. Run `goimports` to format imports.
2. Execute `golangci-lint run ./...` using `.github/.golangci.yaml`.

```bash
goimports -w .
golangci-lint run ./... -v -c .github/.golangci.yaml
```

(scripts/lint.sh)

---

## scripts/run_tests.sh

**Purpose:** Run unit tests with coverage and generate HTML report.

- Redirects logs to `coverage/log.txt`.
- Uses:
- `ENV_FILE_NAMES=config.test.env,config.dev.env`
- `PROJECT_ROOT_PATH=$(pwd)`
- Runs `go test` with `-race`, coverage profile, and opens HTML.

```bash
exec 6>&1
exec > coverage/log.txt
start_time=$SECONDS
fileName="coverage/_coverage.out"
htmlPath="coverage/_coverage.html"

ENV_FILE_NAMES=config.test.env,config.dev.env PROJECT_ROOT_PATH=$(pwd) \
  go test -v -race -cover --count=1 -p=4 \
    -coverprofile=$fileName -covermode=atomic -coverpkg=./... ./...
testExitCode=$?

go tool cover -html=$fileName -o=$htmlPath
exec 1>&6 6>&-
elapsed=$(( SECONDS - start_time ))
echo "$elapsed s"

if [ $testExitCode -ne 0 ]; then
  echo "FAILED"
  exit $testExitCode
fi
echo "PASSED"
```

(scripts/run_tests.sh)

---

## scripts/migrate.sh

**Purpose:** Prompt and run database migrations.

- Asks user for confirmation (`Y/n`).
- On approval, invokes:

```bash
  ENV_FILE_NAMES=config.test.env,config.dev.env PROJECT_ROOT_PATH=$(pwd) \
    go run main.go -migrate=true -server=false
```

(scripts/migrate.sh)

---

## scripts/startdev.sh

**Purpose:** Launch development server with live reload.

1. Ensure `config/config.dev.env` exists.
2. Export all vars from `config.test.env` and override with `config.dev.env`.
3. Start `modd` with `CONFIG_FILE_NAME=config.dev.json`.

```bash
#!/bin/sh
filename=./config/config.dev.env
test -f $filename || touch $filename
set -o allexport
source ./config/config.test.env
source ./config/config.dev.env
set +o allexport

CONFIG_FILE_NAME=config.dev.json modd
```

(scripts/startdev.sh)

---

## scripts/start_cron_mode.sh

**Purpose:** Build and run the cleanupâ€cron mode.

- Builds `./rudder` binary with race detector.
- Runs with cleanup flag, sourcing both test and dev env files:

```bash
#!/bin/sh
filename=./config/config.dev.env
test -f $filename || touch $filename

go build -race -o ./rudder
ENV_FILE_NAMES=config.test.env,config.dev.env PROJECT_ROOT_PATH=$(pwd) \
  ./rudder -cleanup-cron=true
```

(scripts/start_cron_mode.sh)

---

## scripts/newline.sh

**Purpose:** Ensure every file ends with a newline.

- Scans extensions: `go`, `sh`, `yaml`, `md`, `json`.
- Appends a newline if missing.

```bash
#!/bin/bash
extensions=("go" "sh" "yaml" "md" "json")
find . -type f \( -name "*.go" -o -name "*.sh" -o ... \) | while read -r file; do
  if [[ $(tail -c1 "$file" | wc -l) -eq 0 ]]; then
    echo "Adding newline to: $file"
    echo >> "$file"
  fi
done
echo "Finished processing files."
```

(scripts/newline.sh)

---

## Local Workflow Examples

1. **Install dependencies**

```bash
   make installdeps
```

1. **Run dev server**

```bash
   make run
```

1. **Execute tests**

```bash
   make test
```

1. **Apply migrations**

```bash
   make migrate
```

1. **Format & lint**

```bash
   make fmt
   make lint
```

1. **Run cleanup cron**

```bash
   make run-cron
```

These targets and scripts coordinate common day-2 operations, ensuring consistency across environments and speeding up developer feedback loops.
# 29. Build, Deployment, and CI/CD (.azure + Docker + Scripts)

29.1 Docker image build and runtime contract

This section describes how the Rudder service image is built, what it contains at runtime, and the contract it exposes. It covers the multi-stage Go build, runtime base image, copied configuration assets, shared libraries, entrypoint, environment variables, and the expected mount paths and ports.

## Dockerfile overview

The Dockerfile uses a **multi-stage build** to produce a minimal, static Go binary and then packages it into a lightweight Alpine image for runtime .

```dockerfile
# ---------- Build Stage ----------
FROM golang:1.24.13-alpine as build-env
RUN mkdir /app
WORKDIR /app
COPY go.mod . 
COPY go.sum .
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
    go build -a -installsuffix cgo -o /go/bin/app -buildvcs=false

# ---------- Runtime Stage ----------
FROM alpine:3

ARG TAG_NAME
ARG SHORT_SHA
ENV TAG_NAME=$TAG_NAME
ENV SHORT_SHA=$SHORT_SHA

# hadolint ignore=DL3018
RUN apk update && \
    apk upgrade && \
    apk add --no-cache libcrypto3 libssl3 && \
    rm -rf /var/cache/apk/*

RUN mkdir -p /config
COPY ./config/*.json /config/
COPY --from=build-env /go/bin/app /go/bin/rudder
ENTRYPOINT ["/go/bin/rudder"]
```

## üöß Build Stage

- **Base image**: `golang:1.24.13-alpine`
- **Dependencies**: `go.mod` and `go.sum` are copied and `go mod download` is run for cacheable dependency resolution.
- **Source**: Entire repository is copied after dependencies to leverage Docker layer caching.
- **Binary build**:
- `CGO_ENABLED=0` for a static binary
- Target OS/ARCH: `linux/amd64`
- Output: `/go/bin/app`

## üèÉ Runtime Stage

- **Base image**: `alpine:3`
- **Environment variables**: `TAG_NAME`, `SHORT_SHA` (passed at build time)
- **Shared libraries**: Installs `libcrypto3` and `libssl3` for TLS operations
- **Configuration directory**: `/config`
- **Entrypoint**: `/go/bin/rudder`

## Environment Variables

| Name | Description | Set By |
| --- | --- | --- |
| TAG_NAME | Full Docker tag (e.g., `main-<commit>`) | Azure pipeline script |
| SHORT_SHA | Abbreviated Git SHA for this build | Azure pipeline script |


## üìö Shared Libraries

- libcrypto3
- libssl3

These are installed in the runtime image to support HTTPS and cryptographic operations.

## Configuration Assets

All JSON configuration files under `./config/*.json` in the repository are copied into the image‚Äôs `/config` directory. At startup, the service reads environment-specific settings (ports, database connection, external service URLs) from these files.

## Volume and Mount Paths

| Path | Purpose |
| --- | --- |
| `/config` | Mounted directory for JSON config files |


You may mount additional files or override `/config` at runtime for environment-specific overrides.

## Ports

The Dockerfile does not declare an `EXPOSE` instruction. The service binds to the HTTP port defined in its configuration under `/config/*.json`.

- **Mapping**: Container port ‚Üí Host port or Kubernetes Service port must match the value in the config file.
- **Example**: If `server.port` is set to `8080` in `config.dev.json`, map `-p 8080:8080`.

---

This contract ensures a small, secure, and reproducible container image that can be deployed in any standard Docker or Kubernetes environment, with clear separation of build-time artifact creation and runtime dependencies.
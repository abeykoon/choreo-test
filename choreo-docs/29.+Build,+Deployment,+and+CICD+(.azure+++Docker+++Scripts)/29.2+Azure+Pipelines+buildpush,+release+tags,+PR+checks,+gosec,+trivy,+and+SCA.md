# 29.2 Azure Pipelines: Build/Push, Release Tags, PR Checks, GoSec, Trivy, and SCA

This section describes the Azure Pipelines configuration in the `.azure/` directory. It covers:

- **Build** and **release** pipelines
- **Pull request** checks
- **Security** and **composition** scans
- **Template** composition and **artifact** outputs

## Pipeline Files Overview

Below is a summary of the key YAML files under `.azure/` and their roles:

| File | Purpose |
| --- | --- |
| `.azure/dp-rudder-build.yaml` | Builds Docker image on `main`, tags, pushes |
| `.azure/dp-rudder-release.yaml` | Builds & pushes on release **tags** `v*` |
| `.azure/dp-rudder-pr-check.yaml` | Runs tests, Docker build & Trivy on PRs |
| `.azure/dp-rudder-gosec.yaml` | Runs GoSec security scanner on branches |
| `.azure/dp-rudder-sca-scan.yaml` | Scheduled daily SCA (FOSSA) scan |
| `.azure/dp-rudder-linter.yaml` | GolangCI and Hadolint lint checks |
| `.azure/templates/coverage-steps.yml` | Common coverage, test, and publish steps |
| `.azure/templates/install-go.yml` | Installs Go toolchain and caches modules |
| `.azure/templates/trivy-docker-scan.yaml` | Docker image vulnerability scanning template |


---

## Build Pipeline (`dp-rudder-build.yaml`) üê≥

This pipeline triggers on `main`. It:

- **Generates** a Docker tag using the commit SHA
- **Builds** the image with both `<revision>` and `latest` tags
- **Runs** unit tests and publishes coverage
- **Scans** the image with Trivy
- **Pushes** the image to ACR
- **Updates** overlays and notifies via Hangouts

```yaml
jobs:
  - job: build
    displayName: Build/DockerPush
    pool:
      vmImage: ubuntu-latest
    steps:
      - script: |
          APP_REVISION="master-$(Build.SourceVersion)"
          echo "##vso[task.setvariable variable=APP_REVISION]${APP_REVISION}"
        displayName: Generate Docker tag
      - task: Docker@2
        displayName: Docker Build
        inputs:
          command: build
          repository: $(REPOSITORY)
          tags: |
            $(APP_REVISION)
            latest
      - template: templates/coverage-steps.yml
      - template: install/install-trivy.yaml@common-templates
      - template: pr/trivy-scan.yaml@common-templates
        parameters:
          IMAGES:
            - $(CONTAINER_REGISTRY)/$(REPOSITORY):$(APP_REVISION)
      - task: Docker@2
        displayName: Docker Push
        inputs:
          command: push
          repository: $(REPOSITORY)
          tags: |
            $(APP_REVISION)
            latest
      - template: update-image-in-cp-overlays.yml@common-templates
      - template: hangouts-notify.yml@common-templates
```

---

## Release Pipeline (`dp-rudder-release.yaml`) üöÄ

This job runs on Git **tags** matching `v*`. It:

- **Builds** and **pushes** Docker image with the tag name
- **Executes** coverage steps
- **Invokes** Trivy scan

```yaml
trigger:
  branches:
    include:
      - refs/tags/v*
jobs:
  - job: build
    displayName: Build/DockerPush
    pool:
      vmImage: ubuntu-latest
    steps:
      - task: Docker@2
        displayName: Docker Build
        inputs:
          command: build
          repository: $(REPOSITORY)
          tags: |
            $(TAG)
      - template: templates/coverage-steps.yml
      - template: install/install-trivy.yaml@common-templates
      - template: pr/trivy-scan.yaml@common-templates
        parameters:
          IMAGES:
            - $(CONTAINER_REGISTRY)/$(REPOSITORY):$(TAG)
      - task: Docker@2
        displayName: Docker Push
        inputs:
          command: push
          repository: $(REPOSITORY)
          tags: |
            $(TAG)
```

---

## Pull Request Checks (`dp-rudder-pr-check.yaml`)

On every **PR** branch, two jobs run:

1. **ci**: Executes unit tests and publishes coverage
2. **build**: Builds Docker image and runs Trivy

```yaml
pr:
  branches:
    include:
      - "*"
jobs:
  - job: ci
    displayName: Run Tests
    steps:
      - template: templates/coverage-steps.yml
  - job: build
    displayName: Build/DockerPush Image
    pool:
      vmImage: ubuntu-latest
    steps:
      - task: Docker@2
        displayName: Docker Build
        inputs:
          command: build
          repository: $(REPOSITORY)
          tags: |
            $(TAG)
      - template: install/install-trivy.yaml@common-templates
      - template: pr/trivy-scan.yaml@common-templates
        parameters:
          IMAGES:
            - $(CONTAINER_REGISTRY)/$(REPOSITORY):$(TAG)
```

---

## Security and Composition Scans

### Trivy Scan üê≥üîí

The **Trivy** template runs inside a Docker container and exits non-zero on Medium+ vulnerabilities.

```yaml
# .azure/templates/trivy-docker-scan.yaml
parameters:
  - name: registry; default: choreoctrlplane.azurecr.io
  - name: repository
  - name: tag; default: latest
  - name: trivyVersion; default: latest
  - name: trivyExitCode; default: 1

steps:
  - script: |
      docker run --rm \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -v "$PWD/.trivyignore":/.trivyignore:ro \
        aquasec/trivy:${{ parameters.trivyVersion }} image \
        --exit-code ${{ parameters.trivyExitCode }} \
        --severity MEDIUM,HIGH,CRITICAL \
        ${{ parameters.registry }}/${{ parameters.repository }}:${{ parameters.tag }}
    displayName: Scan Docker image
```

### GoSec Scan üîç

This pipeline triggers on all branches (excluding `main`) and PRs, installing and running **GoSec**:

```yaml
trigger:
  branches:
    include: ["*"]
    exclude: ["main"]
pr:
  branches: include: ["*"]
variables:
  GOSECVERSION: "2.22.3"
steps:
  - task: GoTool@0
    version: 1.24.13
  - script: |
      curl -sfL https://raw.githubusercontent.com/securego/gosec/master/install.sh \
        | sh -s -- -b $(go env GOPATH)/bin v$(GOSECVERSION)
      $(go env GOPATH)/bin/gosec -exclude=G112,G115 ./...
    displayName: Run GoSec security Scanner
```

### SCA Scan üì¶

Scheduled **daily** at midnight, this job uses a **FOSSA**-based template for Go dependency analysis:

```yaml
schedules:
  - cron: "0 0 * * *"
    displayName: Daily midnight SCA build
trigger: none
pr:
  branches: include: ["*"]
jobs:
  - job: sca_scan
    displayName: SCA scan
    variables:
      - group: choreo-sca-scan
    steps:
      - template: ci-pipelines/templates/sca-scan-go.yaml@templates
        parameters:
          API_KEY: $(FOSSA-API-KEY)
```

### Linting (`dp-rudder-linter.yaml`)

On every branch (excluding `main`), it:

- Installs Go toolchain
- Runs **GolangCI-Lint**
- Validates **Dockerfile** with **Hadolint**

```yaml
steps:
  - template: templates/install-go.yml
  - script: |
      curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh \
        | sh -s -- -b $(go env GOPATH)/bin v1.55.2
      golangci-lint run ./... -v -c .github/.golangci.yaml --timeout=5m
    displayName: Run GolangCI Linter
  - script: |
      docker run --rm -i ghcr.io/hadolint/hadolint < Dockerfile
    displayName: Validate Dockerfile
```

---

## Template Composition

### Coverage Steps (`coverage-steps.yml`)

This template brings up a test database, runs migrations, executes tests, converts results to JUnit and Cobertura, then publishes them.

```yaml
parameters:
  - name: coverageDir; default: coverage
steps:
  - script: docker compose -f docker-compose.yaml up -d
    displayName: Start database
  - template: install-go.yml
  - script: go run main.go -migrate=true -server=false
    displayName: Init database
  - script: |
      go test -v -coverage ... | tee "${{ parameters.coverageDir }}/test.out"
      go-junit-report < "${{ parameters.coverageDir }}/test.out" > report.xml
      gocov-xml < coverage.json > coverage.xml
    displayName: Unit Test
  - task: PublishTestResults@2
  - task: PublishCodeCoverageResults@1
```

### Install Go (`install-go.yml`)

Ensures a pinned Go version and caches Go modules:

```yaml
steps:
  - task: GoTool@0
    displayName: Use Go 1.24.13
    inputs:
      version: 1.24.13
  - task: Cache@2
    inputs:
      key: '"$(Agent.OS)" | **/go.sum'
      path: '$(HOME)/go/pkg/mod'
    displayName: Cache Go packages
```

---

## Artifact Outputs

- **Test Results**: JUnit XML (`report.xml`) published via `PublishTestResults@2`.
- **Coverage**: Cobertura XML (`coverage.xml`) published via `PublishCodeCoverageResults@1`.
- **Docker Images**: Pushed to `choreocontrolplane.azurecr.io/choreoipaas/dp-rudder` with tags.
- **Security Scans**: Trivy and GoSec logs in pipeline console; failures block merges.
- **SCA Reports**: FOSSA output available in pipeline logs.

This setup ensures comprehensive CI/CD automation, secure image builds, and continuous quality checks integrated within Azure DevOps.
### 7.3 Migration Pipeline (v1d1/v1d2 Converters & Helpers) and Internal Config Migrator Service

This section describes the **Migration Pipeline** that upgrades legacy component configuration descriptors (`component.yaml`) to the latest schema versions (v1.1 and v1.2) and the **Config Migration Service** that migrates MI component runtime configurations.

---

## 7.3.1 Migrator Domain

The **Migrator** domain lives under `choreo/bundles/app/configurationdescriptor/migrator` and defines:

| File | Responsibility |
| --- | --- |
| **migrator.go** | `Migrator` interface & `GetMigrator` factory |
| **migrator_v1d1.go** | `MigratorV1D1` → migrate to schema v1.1 |
| **migrator_v1d2.go** | `MigratorV1D2` → migrate to schema v1.2 |
| **converters.go** | Core transformations (endpoints, dependencies, proxy, configs) |
| **helpers.go** | Utility generators (names, paths, “from” metadata) |


**Migrator Flow**

```mermaid
flowchart TD
  A[Load ComponentConfiguration] --> B[GetMigrator(targetVersion)]
  B --> C[Migrate(ctx, content)]
  C --> D[MigrationData (Content, To, From)]
  D --> E[Marshal & Return YAML]
```

---

### 7.3.1.1 Migrator Interface & Factory

```go
type Migrator interface {
  Migrate(ctx context.Context, content *cfg_descriptor.ComponentConfiguration) (*MigrationData, error)
}
func GetMigrator(targetVersion string) Migrator { ... }
```

- Returns `MigratorV1D1` when target is `"1.1"`, else `MigratorV1D2` by default .

---

### 7.3.1.2 v1d1 → v1.1

- Skips if already at v1.1.
- Builds `ComponentDescriptorV1D1`:
- **Endpoints** via `convertEndpointsToEndpointConfigurationV0D2`.
- **Dependencies** via `convertComponentDependencyToDependencyConfigurationV0D2`.

```go
componentYamlV1D1.Endpoints    = convertEndpointsToEndpointConfigurationV0D2(content)
componentYamlV1D1.Dependencies = convertComponentDependencyToDependencyConfigurationV0D2(content)
```

---

### 7.3.1.3 v1d2 → v1.2

- Skips if already at v1.2.
- Builds `ComponentDescriptorV1D2`:
- **Endpoints** & **Dependencies** (same converters).
- **Proxy** via `convertProxyConfigurationToProxyConfigurationV0D1`.
- **Configurations** passthrough (`data.Configurations`).

```go
componentYamlV1D2.Proxy          = convertProxyConfigurationToProxyConfigurationV0D1(content)
componentYamlV1D2.Configurations = convertComponentConfigurationsToConfigurations(content)
```

---

## 7.3.2 Converters & Helpers

#### Converters (transform domain objects)

```go
func convertEndpointsToEndpointConfigurationV0D2(data *ComponentConfiguration) []EndpointConfigurationV0D2
func convertComponentDependencyToDependencyConfigurationV0D2(data *ComponentConfiguration) DependencyConfigurationV0D2
func convertProxyConfigurationToProxyConfigurationV0D1(data *ComponentConfiguration) *ProxyConfigurationV0D1
func convertComponentConfigurationsToConfigurations(data *ComponentConfiguration) *Configuration
```

- **Endpoints**: Map `ComponentEndpoint` → `EndpointConfigurationV0D2`, generating unique names and cleaning schema paths.
- **Dependencies**: Split into `ServiceReferences` (with `ConfigGroupIdentifier`) and `ConnectionReferences`.
- **Proxy**: Only for v1.2; preserves type, visibilities, and asset paths.
- **Configurations**: Directly reuse loaded `Configuration` block.

#### Helpers (metadata & naming)

```go
func generateEndpointName(ep *app.ComponentEndpoint) string
func getSchemaFilePath(schemaFull, projectRoot string) string
func getMigratedFromData(content *ComponentConfiguration) MigratedFileDetails
func getSourceFileNameByGenerationSource(source ConfigSource) string
```

- **Name Generation**: Sanitizes display name and appends hash.
- **Path Cleaning**: Strips project root from file paths.
- **“From” Metadata**: Records original source file and version for audit.

---

## 7.3.3 Invocation Points

1. **API Endpoint**
2. `ComponentConfigController.GetMigratedSrcConfigContent` calls loader, then:

```go
     migrator := migrator.GetMigrator(config.GetConfig().LatestComponentYamlSchemaVersion)
     result, _ := migrator.Migrate(ctx, componentConfig)
```

- Returns base64-encoded YAML of migrated descriptor  .

1. **Admin Endpoint**
2. `POST /internal/admin/migrate-mi-component-configs/{componentId}`
3. Handler invokes `ConfigMigrationService.MigrateMIConfigsForComponent` .

---

## 7.3.4 Internal Config Migrator Service

Located in `internal/services/config_migrator/migrator.go`, the **ConfigMigrationService** automates runtime configuration migration for MI components.

| Interface | Implementation |
| --- | --- |
| `ConfigMigrationService` | `configMigrationService` |
| `MigrateMIConfigsForComponent(ctx, id)` | Iterate releases, migrate each, update flag |


### Workflow

1. **Fetch Component**: Ensure it’s MI-integrated.
2. **Fetch Releases**: Load via `AppEnvRepository`.
3. **For Each Release**:
4. `MigrateMIConfigForRelease`
5. Fetch target environment.
6. Retrieve existing env vars & secrets.
7. Compute missing configs.
8. Create/update config mapping via external service.
9. **Enable Unified Mapping** if all succeed.

---

## 7.3.5 Runbook Integration

A day-2 migration runbook script lives under `migration-scripts/mi-config-migration/migrate.sh`. It:

- Queries MSSQL for MI components needing migration.
- Calls the admin endpoint in batches:

```bash
  curl -X POST "${RUDDER_BASE_URL}/$componentId"
```

- Logs successes/failures .

---

```card
{
    "title": "Key Takeaway",
    "content": "The migration pipeline cleanly separates descriptor upgrades (Migrator domain) from runtime config migration (ConfigMigrator service), enabling both on-demand API migrations and bulk admin-driven migrations via runbooks."
}
```
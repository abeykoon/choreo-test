# 13. APIM Integrations and Utilities

This section covers the integration points and helper utilities used to interact with Choreo‚Äôs API Manager (APIM). It spans four components:

- **APIM Domain** (`external-services/apim`)
- **APIM-AUTH** (`external-services/apim-auth`)
- **APIMUTILS** (`internal/services/apimutils`)
- **APIM-DEV-PORTAL** (`external-services/apim-dev-portal`)

These modules provide the client, data types, helpers, and mocks needed by endpoint and release flows to create, update, version, and manage API lifecycles.

---

## 13.1 APIM Service Client (Publisher / Lifecycle) and Data Types

The **ApiManager** client encapsulates core publisher and lifecycle operations against Choreo APIM Publisher and AppDev APIs. It is used by endpoint controllers and release services to automate:

- API creation, import (Swagger/AsyncAPI) and versioning
- Lifecycle transitions (publish, deprecate, retire, etc.)
- API updates (configuration, security scopes)
- Deletion of APIs
- Retrieval of revisions, deployments, and subscriptions

Implementation lives in `external-services/apim/apim_service.go`, with types defined in `external-services/apim/types.go`.

---

### 13.1.1 ApiManager Interface

The `ApiManager` interface defines all supported operations against APIM Publisher and AppDev endpoints. Each method maps to an HTTP call under the `/api/am/publisher/v2` or `/api/am/appdev/v1` base paths.

```go
type ApiManager interface {
  CreateNewVersion(ctx context.Context, params APIVersionCreateRequest) (*APICreateResponse, error)
  GetAPIById(ctx context.Context, params GetAPIById) (json.RawMessage, error)
  UpdateAPI(ctx context.Context, params GetAPIById, apiDetails json.RawMessage, auditLogsEnabled bool) error
  ImportSwaggerDefinition(ctx context.Context, params APICreateRequest, apiDefinition string) (*APICreateResponse, error)
  ImportAsyncApiDefinition(ctx context.Context, params APICreateRequest, apiDefinition string) (*APICreateResponse, error)
  SearchAPIByContext(ctx context.Context, params SearchAPIByContextRequest) (*SearchAPIByContextResponse, error)
  ChangeAPIStatus(ctx context.Context, params ChangeAPIStatusRequest) (*ChangeAPIStatusResponse, error)
  // Deprecated: Use ProxyDeployer instead
  DeleteAPI(ctx context.Context, params APIDeleteRequest) error
  GetRevisionList(ctx context.Context, params RevisionListRequest) (*RevisionListResponse, error)
  GetDeploymentList(ctx context.Context, params GetDeploymentsAPIMRequest) (GetDeploymentsAPIMResponse, error)
}
```

---

### 13.1.2 Publisher Paths & Constants

```go
const (
  apimPublisherBasePath = "/api/am/publisher/v2"  // Publisher lifecycle
  getAPIUrlPath         = "/apis"                 // Core API root
  appDevBasePath        = "/api/am/appdev/v1"     // App Developer APIs
  correlationHeader     = "activityid"
)
```

- **apimPublisherBasePath**: Prefix for create/version/import/update/delete.
- **appDevBasePath**: Used by methods like CreateAPIMApplication and key mappings.

---

### 13.1.3 Core Methods Overview

| Method | HTTP Verb & Path | Description |
| --- | --- | --- |
| CreateNewVersion üéØ | POST `/apis/copy-api` | Clone an existing API into a new version. |
| ImportSwaggerDefinition | POST `/apis` | Create API from Swagger spec. |
| ImportAsyncApiDefinition | POST `/apis` | Create API from AsyncAPI spec. |
| UpdateAPI üîÑ | PUT `/apis/{apiId}` | Update API config, visibility, endpoints. |
| SearchAPIByContext üîç | GET `/apis?context={ctx}` | Lookup API by its context path. |
| ChangeAPIStatus ‚öôÔ∏è | POST `/apis/change-lifecycle` | Transition API lifecycle (publish, deprecate). |
| DeleteAPI ‚ùå | DELETE `/apis/{apiId}` | Remove an API (deprecated). |
| GetRevisionList | GET `/apis/{apiId}/revisions` | List all revisions of an API. |
| GetDeploymentList | GET `/apis/{apiId}/deployments` | List deployed revisions and timestamps. |


Each method automatically attaches:

- `organizationId` query parameter
- `Authorization: Bearer <token>` header (via APIM-AUTH)
- `Content-Type: application/json`
- `activityid` for tracing

---

### 13.1.4 Data Types

#### APIM Environment & Settings

```go
type APIMVhost struct {
  Host            string `json:"host"`
  HTTPContext     string `json:"httpContext"`
  HTTPPort        int    `json:"httpPort"`
  HTTPSPort       int    `json:"httpsPort"`
  // ‚Ä¶
}

type APIMEnvironment struct {
  Id               string     `json:"id"`
  Name             string     `json:"name"`
  DisplayName      string     `json:"displayName"`
  Type             string     `json:"type"`
  ServerURL        string     `json:"serverUrl"`
  ShowInAPIConsole bool       `json:"showInApiConsole"`
  Vhosts           []APIMVhost `json:"vhosts"`
}

type APIMSettings struct {
  Environment []APIMEnvironment `json:"environment"`
}
```

- **APIMEnvironment**: Describes each APIM instance (dev, prod), including vhosts and console visibility.
- **APIMSettings**: Wraps the list of environments returned by `GetPublisherSettings`.

#### API Keys

```go
type ApiKeysRequest struct {
  OrganizationUUID string
  APIEnvironmentId string
  APIId            string
}

type ApiKeysResponse struct {
  ProductionEndpoint    string `json:"productionEndpoint"`
  SandboxEndpoint       string `json:"sandboxEndpoint"`
  SandboxEndpointChoreo string `json:"sandboxEndpointChoreo"`
}
```

- Used to retrieve per-environment API invocation URLs.

#### Revision & Deployment

```go
type RevisionListRequest struct {
  OrganizationUUID string
  APIId            string
}

type GetDeploymentsAPIMRequest struct {
  OrganizationUUID string
  APIId            string
}

type DeployedRevision struct {
  RevisionUUID       string  `json:"revisionUuid"`
  Name               string  `json:"name"`
  Vhost              string  `json:"vhost"`
  DisplayOnDevportal bool    `json:"displayOnDevportal"`
  DeployedTime       *int64  `json:"deployedTime"`
}
type GetDeploymentsAPIMResponse = []DeployedRevision
```

- **GetDeploymentsAPIMResponse** returns deployed revision details used to build endpoint URLs.

---

### 13.1.5 Mock Implementation

A generated mock (`apim_service_mock.go`) enables unit tests to assert on client calls without real HTTP traffic. It tracks each method invocation along with the passed parameters.

```go
// Example: verifying a version creation call
mockApiManager.CreateNewVersionFunc = func(ctx context.Context, params APIVersionCreateRequest) (*APICreateResponse, error) {
  // test-specific behavior
}
```

Mock helpers like `CreateNewVersionCalls()` return the recorded calls for validation.

---

> **Note** All methods use the **TokenManager** from APIM-AUTH to fetch OAuth2 tokens transparently before making HTTP requests.

This client abstraction decouples publisher/lifecycle logic from controllers and services, enabling reliable API management within Choreo‚Äôs data-plane orchestration.
# 31 Diagrams and Documentation Assets (Sequence Diagrams Domain)

This section covers the PlantUML-based sequence diagrams under `docs/sequence_diagrams` and `docs/sequence_diagrams/fragments`. These diagrams visualize core Rudder workflows and link back to the Go HTTP handlers and external services. They live alongside their Groovy scripts; to update a diagram, edit its `.groovy` file and re-run the PlantUML generation (e.g. via the project’s Makefile).

## 31.1 Sequence Diagrams for Key Workflows and How to Maintain Them

Below is an overview of each key workflow diagram, its purpose, the Groovy script location, and the corresponding API/handler in the codebase.

| Workflow | Diagram File | Description | Code Path / Endpoint |
| --- | --- | --- | --- |
| Component Creation | `docs/sequence_diagrams/component_create.groovy` | Shows how a GraphQL client creates a new component: token secret creation, DB transaction, APIM proxy setup, and CICD repo bootstrap. | HTTP POST /api/v1/choreo/components handled by `ChoreoAppController.CreateChoreoApplication` |
| Image Deploy Webhook | `docs/sequence_diagrams/deploy_webhook.groovy` | Captures a CI/CD webhook (e.g. Harbor) triggering an image deploy: DB lookup, optional proxy generation, Mizzen deployment, and APIM revision. | HTTP POST /choreo/webhooks/v1/image handled by `DeployNewImage` in `webhooks` package |
| Release Promotion | `docs/sequence_diagrams/promote_release.groovy` | Illustrates promoting a release from one environment to another: DB reads, image promotion, Mizzen deploy, and APIM revision promotion. | GraphQL mutation → `ChoreoAppController.PromoteApplication` in `choreo/bundles/app` |
| Fragments<br/>– GetSecret | `docs/sequence_diagrams/fragments/get_secret_by_id.groovy` | Sub-flow for retrieving a deploy token from Secret Manager via AzureKV. | Internal call in `secretManager` service |
| Fragments<br/>– Create & Deploy Revision | `docs/sequence_diagrams/fragments/revision_create_deploy.groovy` | Sequence for APIM revision lifecycle: update definition, cleanup old revisions, create new revision, update vhosts, and deploy. | `ApiManager.UpdateSwagger`, `ApiManager.GetRevisions`, `ApiManager.CreateRevision​` in `external-services/apim` |
| Fragments<br/>– Promote Revision | `docs/sequence_diagrams/fragments/promote_revision.groovy` | Shows how Rudder promotes an existing APIM revision to a target environment and notifies Project Manager. | `ApiManager.GetDeployments`, `ApiManager.UpdateServiceURL`, `ApiManager.DeployRevision` |


---

### Component Creation Workflow

```plaintext
title Create component

participant "GraphQL API" as GQL
participant Rudder
participant CICD
participant APIM
participant "Secret Manager" as SecretManager
participant DB

GQL-->Rudder: Create Component
...
Rudder-->GQL: success
```

- **Purpose**: Bootstraps a new Choreo component.
- **Key Steps**:
- Generate an image-deploy token and store as a secret (`SecretManager` → AzureKV).
- Begin DB transaction to save component, API version, releases.
- If proxy required, call APIM to create a proxy.
- Return success, then instruct CICD to create repos and fetch the deploy token.
- **Maps to**:
- Handler: POST /api/v1/choreo/components → `ChoreoAppController.CreateChoreoApplication`
- Bundle: `internal/bundles/app/choreoAppController.go`

---

### Image Deploy Webhook Workflow

```plaintext
title Image Deploy

participant "Github Action" as Action
participant Rudder
participant CICD
participant APIM
participant SecretManager
participant ProjectManager
participant Mizzen
database DB

Action->Rudder: DeployImage
...
Rudder->Action:  
```

- **Purpose**: Automates image deployment on push events.
- **Key Steps**:
- Validate token and lookup component/environment in MSSQL.
- Optionally fetch OpenAPI defs from CICD.
- Save new image record, notify Project Manager.
- Deploy workloads via Mizzen (Deployment/CronJob or Service), then create APIM revision and deploy proxy.
- **Maps to**:
- Endpoint: POST /choreo/webhooks/v1/image → `DeployNewImage` in `internal/webhooks`
- DB Access: `internal/common/db` gorm models

---

### Release Promotion Workflow

```plaintext
title Promote release

participant "GraphQL API" as GQL
participant Rudder
participant CICD
participant APIM
participant Mizzen
database DB

GQL->Rudder: Promote release
...
Rudder->GQL:
```

- **Purpose**: Moves a release from a source env to a target env.
- **Key Steps**:
- Fetch component, environment, releases, API version.
- Optionally refresh OpenAPI via CICD.
- Promote container image, update release info.
- Deploy via Mizzen and, if proxy required, call APIM to promote the revision.
- **Maps to**:
- GraphQL resolver in `choreo/bundles/app` invoking `choreoAppController.promoteRelease`.
- Post-action: calls to `appEnvService.PromoteReleaseImageToTarget` and `apiVersionService` methods.

---

### Fragment: Get Secret by ID

```plaintext
title GetSecret

participant Rudder
participant SecretManager
participant AzureKV
database DB

Rudder->SecretManager: GetSecret(secretId)
...
```

- **Purpose**: Common sub-flow for retrieving secrets.
- **Maps to**:
- Service method `vault-service.Client.GetSecret` in `external-services/vault-service`.

---

### Fragment: Create & Deploy APIM Revision

```plaintext
title CreateRevisionAndDeploy

participant Rudder
participant APIM
participant ProjectManager

Rudder->APIM: Update openapi definition
...
ProjectManager-->>Rudder:
```

- **Purpose**: Encapsulates APIM revision creation & deployment logic.
- **Maps to**:
- `apiManager.ImportSwaggerDefinition`, `GetRevisions`, `CreateRevision`, `DeployRevision` calls in `external-services/apim`.

---

### Fragment: Promote APIM Revision

```plaintext
title Promote revision

participant Rudder
participant APIM
participant ProjectManager

Rudder->APIM: Get Deployments
...
ProjectManager-->>Rudder:
```

- **Purpose**: Handles promotion of an existing APIM revision from one vhost to another.
- **Maps to**:
- `apiManager.GetDeployments`, `UpdateServiceURL`, `DeployRevision`.

---

## Maintaining Sequence Diagrams

- **Location**: All `.groovy` scripts reside under `docs/sequence_diagrams` and its `fragments` subfolder.
- **Edit**: Update message texts or participants in the Groovy script to reflect code changes.
- **Generate**: Run `make diagrams` (or equivalent) to regenerate PNG/SVG assets via PlantUML.
- **Version**: Check changes into Git alongside related handler code updates.
- **Tips**:
- Keep diagram steps in sync with handler method signatures and endpoint paths.
- Update fragment diagrams whenever the APIM or Secret Manager integration is modified.